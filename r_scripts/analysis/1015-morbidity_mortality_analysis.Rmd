---
title: "Colorado wildfire smoke and cardiopulmonary morbidity"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

## Introduction

This Mark Down file contains code and results evaluating the effect of wildfire smoke on cardiopulmonary morbidity and mortality along the Colorado front range communities from 2010 to 2015. The hypothesis for this study is that we will see an increase in the risk of cardiopulmonary morbidity and mortality associated with an increase in PM2.5 due to wildfire smoke.

```{r setup, include = F}
# library
library(tidyverse)
library(survival)

# knitr options
knitr::opts_chunk$set(fig.width=8, fig.height=6, 
                      warning=FALSE, message=FALSE, echo = FALSE)
```

## Smoke PM2.5

Kate has estimated PM2.5 at 15x15 km grid level using kriged surface site monitors for the entire US from 2010 to 2015. I have limited the gridded PM2.5 to Colorado. I have also estimated population-weighted PM2.5 for all Colorado counties. There were concerns about the accuracy of the krig PM in areas outside of the front range communities since most PM stations are on the front range. 

```{r lag_fun}
# defining a lag function that I will use later in the distributed lag model
funlag <- function(var, n=5){
  var <- enquo(var)
  indices <- seq_len(n)
  map( indices, ~quo(lag(!!var, !!.x)) ) %>% 
    set_names(sprintf("%s_lag%d", rlang::quo_text(var), indices))
}
```


```{r import_county_pm}
# front range fips
fr_fips <- c("08001", "08005", "08013", "08031", "08035", "08041",
             "08059", "08069", "08123")

# read pm data 
co_pm <- read_csv("../../data/smoke/1015-county_popwt_pm.csv") %>% 
  # limiting to colorado counties only by reading 1st 2 digs of 5-dig fips code
  filter(fips %in% fr_fips) %>% 
  # renaming variable pm_smk to pm_diff; more accurate description of var
  rename(pm_diff = pm_smk) %>% 
  # us
  mutate(county_name = case_when(fips == '08001' ~ 'Adams',
                                 fips == '08005' ~ 'Arapahoe',
                                 fips == '08013' ~ 'Boulder',
                                 fips == '08031' ~ 'Denver',
                                 fips == '08035' ~ 'Douglas',
                                 fips == '08041' ~ 'El Paso',
                                 fips == '08059' ~ 'Jefferson',
                                 fips == '08069' ~ 'Larimer',
                                 fips == '08123' ~ 'Weld'),
         day = as.factor(weekdays(date)), # create day of week based on var
         weekend = ifelse(day %in% c("Saturday", "Sunday"), 1, 0),
         month = as.factor(lubridate::month(date)), # extract month as factor
         year = as.factor(lubridate::year(date)), # extract year as factor
         season = as.factor(case_when(month %in% c(12, 1, 2) ~ "winter",
                                      month %in% c(3:5) ~ "spring",
                                      month %in% c(6:8) ~ "summer",
                                      month %in% c(9:11)~ "fall")),
         # creating binary smoke to require 50% of county with smoke overhead
         # and difference between estimate and seasonal background to be >0
         # and to be within the month of April to Octoboer
         smoke0_hms = ifelse(pm_diff > 0 & month %in% c(5:10) & hms > 0.5,1,0),
         smoke5_hms = ifelse(pm_diff > 5 & month %in% c(5:10) & hms > 0.1,1,0),
         smoke10_hms = ifelse(pm_diff > 10 & month %in% c(5:10) & hms > 0.1,1,0),
         smoke15_hms = ifelse(pm_diff > 15 & month %in% c(5:10) & hms > 0.1,1,0),
         # transforming pm kriged estimates to a 10 unit increase in pm
         pm = pm_krig/10, 
         # continuous pm smoke accounting for hms
         cpm_smk = ifelse(hms > 0.1 & month %in% c(5:10), pm_diff, 0),
         cpm_smk = ifelse(cpm_smk < 0, 0, cpm_smk),
         aqi_warning = ifelse(aqi_cat %in% 
            c('Unhealthy', 'Unhealthy for Sensitive Groups'), 1, 0)) %>%  
  # sorting by fips and date to estimate lag for each county by date
  arrange(fips, date) %>% 
  # group by fips 
  group_by(fips) %>%
  # apply funlag to create lagged estimates
  mutate(., !!!funlag(pm,3), !!!funlag(smoke0_hms,3), !!!funlag(smoke5_hms,3),
         !!!funlag(smoke10_hms,3), !!!funlag(smoke15_hms,3), 
         !!!funlag(temp_f, 3)) %>% 
  select(-state, -month) # removing state and month to bind with casecross
```

### County Population-Weighted Smoke PM2.5 2010 to 2015

To try and estimate PM2.5 from smoke vs. other sources, I've taken the estimated kriged value of PM2.5 and subtracted off the seasonal background of PM2.5 and only consider this difference to be from smoke if there is smoke in the atmospheric column using the HMS grids. For county population-weighted values, I use a rather loose definition of at least 10% of the county with smoke overhead. The grid-level estimate of smoke is probably more reliable. I'll show some quick diagnostic plots below.

Here is a plot of the population-weighted smoke PM2.5 for each Front Range county.       

```{r pm_ts_plot}
pm_plot <- ggplot(data=co_pm, aes(x=date, y=cpm_smk)) +
  geom_point(size = 0.5, color = "#6441a5") +
  facet_wrap(~county_name) +
  xlab('Date') +
  ylab('County Smoke PM2.5 ug/m^3') +
  theme_minimal()
# plot
print(pm_plot)
```

This definition of smoke seems reasonable. I do have some concerns with the Kriged model in that there isn't enough stations to capture spatial variations. For example, the 2012 Waldo Canyon Fire likely affected south Front Range counties like El Paso a little after the High Park Fire likely affected northern front range counties like Larmier. Does the county population-weighted time series reflect this? All the smoke peaks across look uniform across Front Range counties. This could be explained by the kriging process if certain sites are really driving the smoothed surfaces. 

Maps of the study area and specific fires may help understand the exposure series. I will work on these after some input.

```{r grid_pm}
# code chunk that reads in grid pm2.5 and prepares some lagged variables
# for joining with health outcomes data.

# read new grid/wrfgrid key
grid_key <- read_csv('../../data/shapefiles/wrfgrid_key.csv', 
                     col_types = list(GRID_ID = col_character(),
                                      WRFGRID_ID = col_character())) %>% 
  select(-COLX, -ROWY)

# read grid pm
grid_pm <- read_csv('../../data/smoke/1015-grid_pm.csv', 
                    col_types = list(GRID_ID = col_character())) %>% 
  # create some variables         
  mutate(pm_diff_g = pm25_grid - sbg_pm_grid,
         month = as.factor(lubridate::month(date)), # extract month as factor
         gsmk5_hms = ifelse(pm_diff_g > 5 & month %in% c(4:10) & hms_grid == 1,
                            1,0),
         gsmk10_hms = ifelse(pm_diff_g > 10 & month %in% c(4:10) & hms_grid == 1,
                             1,0),
         gsmk15_hms = ifelse(pm_diff_g > 15 & month %in% c(4:10) & hms_grid == 1,
                             1,0),
         # continuous pm smoke accounting for hms
         gpm_smk = ifelse(hms_grid == 1 & month %in% c(5:10), pm_diff_g, 0),
         gpm_smk = ifelse(gpm_smk < 0, 0, gpm_smk),
         # transforming pm smke estimates to a 10 unit increase in pm
         gpm_smk10unit = gpm_smk/10) %>% 
         # sorting by GRID_ID and date to estimate lag for each county by date
         arrange(GRID_ID, date) %>% 
         # group by GRID_ID 
         group_by(GRID_ID) %>%
         # apply funlag to create lagged estimates
         mutate(., !!!funlag(gpm_smk10unit,3), !!!funlag(gsmk5_hms,3),
               !!!funlag(gsmk10_hms,3), !!!funlag(gsmk15_hms,3),
               !!!funlag(temp_f_grid, 3)) %>% 
         select(-month) 
```

## Hospitalizations and Mortality

I've created time-stratified case-crossover data frames for both mortality and hospitalization data provided by CDPHE with reference periods within a month of the observation. The justification for a 'month' period is appropriate for mortality I think, as I think it's reasonable counter factual window in when a person could have died. A longer period like we've previously used like the entire wildfire season may not be as appropriate for mortality for a person who is already at risk of death.

### Hospitalizations

```{r load_morbidity}
# load casecross list
load("../../data/health/1015-co_morbidity_casecross_list.RData")
# load icd9
load("../../data/health/icd9_outcome_vectors.RData")
```

Cleaning hospitalization data and joining with both grid-level and count-level PM2.5 data. I consider the following inpatient hospitalization events with admitting source via the emergency room or urgent care (as a way to get at acute events): all respiratory, asthma, chronic obstructive pulmonary disease (COPD), acute bronchitis, pneumonia, all cardiovascular events, arrhythmia, cerebrovascular, heart failure, ischemic heart disease, and myocardial infraction (which is a subcategory of IHD).

Some notes for the Colorado hospitalization data is that unlike Washington and Oregon, I have no way of identifying multiple events per person so I am not able to limit to first event and I am assuming each event is independent of others. Also, unlike Washington and Oregon, I've decided to go with monthly referent periods rather than the whole wildfire season. Possible suggestion would be to run sensitivity analyses to see if this has an impact.

```{r hosp_pm}
# extract names
outcome <- c('All Respiratory', 'Asthma', 'COPD', 'Acute Bronchitis',
              'Pneumonia', 'All CVD', 'Arrhythmia', 'Cerebrovascular',
              'Heart Failure', 'Ischemic Heart Disease', 
              'Myocardial Infarction')

# reduce case-crossover list to only summer months and join GRID ID
co_hosp_list <- co_morbidity_cc_list %>% 
  # desired format to make sure it's right
  map(~ mutate(., outcome = as.numeric(as.character(outcome)),
               date = as.Date(as.character(date)),
               month = as.factor(lubridate::month(date))) %>% 
      # filter out 2016; I don't have pm data yet
      filter(date <= "2015-12-30") %>% 
      filter(month %in% 5:10) %>% 
      filter(fips %in% fr_fips) %>% 
      select(-state, -month) %>% 
      # join with grid key
      left_join(grid_key, by = 'WRFGRID_ID') %>% 
      left_join(co_pm, by = c("fips", "date")) %>% 
      # left join grid pm
      left_join(grid_pm, by = c("GRID_ID", "date"))) %>% 
  # add outcome name to each dataframe
  map2(.x = ., .y = outcome, ~mutate(.x, out_name = .y))
```

### Colorado Hospitalization Respiratory and Cardiovascular Time Series

Creating and plotting the time series of respiratory and cardiovascular events for the state of Colorado. 

```{r hosp_ts}
# create time series of hospitalizations
ts_hosp <- co_morbidity_cc_list[c(1,6)] %>% 
  # using map 2 to add outcome names to each dataframe
  map2(., names(co_morbidity_cc_list[c(1,6)]), function(df, name){
    counts <- df %>% 
      filter(outcome == 1) %>% 
      group_by(date) %>% 
      summarise(n = n()) %>% 
      mutate(outcome = name,
             date = as.Date(date))
    }) %>% 
  # bind dataframes
  map_dfr(.,rbind)

```

```{r hosp_ts_plot}
ts_hosp_plot <- ggplot(data=ts_hosp, aes(x=date, y=n)) +
  geom_point() +
  facet_wrap(~outcome) +
  theme_minimal()

ts_hosp_plot
```

The cardiovascular hospitalization is pretty uniform, with some noticeable dips at the end of the year of 2013 and when ICD9 switches to ICD10 at the end of the time series. I'd say this is probably a systemic thing that has to do with coding or how hospitals recorded events rather than an actual big drop in the rate of CVD hospitalizations. Although may Kirk or some others at CDPHE may know.

### Counts of Hospitalization Events

Number of inpatient hospitalization events that occurred in Colorado Front Range Communities between 2010 and 2015 in the May to October Months. Also note that October of 2015 is when ICD9 was switched to ICD10, so I do not have that last month.

```{r hosp_counts}
# estimate deaths 
hosp_counts <- co_hosp_list %>% 
  map_dfr(. , function(df){
    counts <- df %>% 
      filter(outcome == 1) %>% 
      group_by(out_name) %>% 
      summarise(n = n())
    })
# print death counts
knitr::kable(hosp_counts, caption = 'Number of Inpatient Events')
```

### Assessment of Assigned PM2.5

Quick assessment of how well my smoke PM2.5 definition at the grid level correlates at the county level for front range counties. I've used the cardiovascular hospitalizations (as they are most common) to plot the assigned county smoke PM2.5 vs grid smoke PM2.5 It looks like the values are similar in some respect, and sometimes not. I would assume the grid level is more accurate since my definition requires the grid be completely impacted by smoke based on the HMS plume.

```{r assigned_pm}
ggplot(data = filter(co_hosp_list[[6]], !is.na(gpm_smk)), 
                     aes(x=cpm_smk, y =gpm_smk)) +
  geom_point() +
  ylab('Grid Smoke PM2.5') +
  xlab('County Smoke PM2.5') +
  ggtitle('Comparison of County vs Grid Smoke PM2.5') +
  theme_minimal()
```

Check how many events have a county PM assigned but not a grid PM assigned.

```{r missing_grid}
missing <- co_hosp_list[[6]] %>% 
  filter(outcome == 1) %>% 
  mutate(county_miss = ifelse(is.na(pm_krig), 1, 0),
         grid_miss = ifelse(is.na(pm25_grid), 1, 0)) %>% 
  group_by(county_miss, grid_miss) %>% 
  summarize(n = n()) %>% 
  mutate(prop = round(n/(69064+8716), 2))

knitr::kable(missing, caption = 'CVD Hospitalization Proportion Missing Grid PM2.5')
```

Roughly 10% of subjects with a CVD hospitalization are missing grid PM2.5 which I'm guessing is because Kirk was not able to Geocode for what ever reason.

### Same Day Association between Smoke PM2.5 and Inpatient Hospitalizations

First things first is to look at the same day association between an increase in smoke PM2.5 and the risk for an inpatient hospitalization.

```{r sameday_model}
# extract names
outcome <- c('All Respiratory', 'Asthma', 'COPD', 'Acute Bronchitis',
              'Pneumonia', 'All CVD', 'Arrhythmia', 'Cerebrovascular',
              'Heart Failure', 'Ischemic Heart Disease', 
              'Myocardial Infarction')
# outcome order
out_order <- c('All Respiratory', 'Asthma', 'COPD', 'Acute Bronchitis',
              'Pneumonia', 'All CVD', 'Arrhythmia', 'Cerebrovascular',
              'Heart Failure', 'Ischemic Heart Disease', 
              'Myocardial Infarction')

# same day results
same_day <- co_hosp_list %>% 
  map_dfr(., function(df){
    out_name <- unique(df$out_name)
    result <- broom::tidy(clogit(outcome ~ gpm_smk10unit + 
                                 temp_f_grid + strata(id),
                                 data = df)) %>% 
      filter(term == 'gpm_smk10unit') %>% 
      select(term, estimate, conf.low, conf.high) %>% 
      mutate_at(vars(estimate:conf.high), exp)
  }) %>%
  bind_cols(data.frame(outcome), .) %>% 
  mutate(outcome = forcats::fct_relevel(outcome, out_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
         "Respiratory", "Cardiovascular")))
```

Same-day plot.

```{r sameday_plot}
# plot
plot <- ggplot(data=same_day, aes(x=outcome, y = estimate, colour = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: Smoke PM"[2.5], " > 10 ug/m"^3))) +
  xlab("Outcome") +
  ggtitle('Hospitalization and Same Day Smoke Exposure') +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75))

print(plot)
```

There is no association for most outcomes. Notable observation would be the inverse association between increasing smoke and a lower likelihood of a respiratory hospitalization. 

### Cumulative effect for a 10 ug/m^3 of smoke exposure over 4 days

```{r lag_function}
distribute_that_lag <- function(lag_mod, strata) {
  # output pm basis estimates
  parms <- broom::tidy(lag_mod) %>% 
    filter(stringr::str_detect(term, strata)) %>% 
    select(estimate) %>% 
    as_vector()
  # output estimate names for cov matrix
  names <- stringr::str_subset(names(lag_mod$coefficients), strata)
  # define lagged basis spline if it doesn't exist
  exp_b <- splines::ns(0:3, df = 3, intercept = T)
  # estimate associations
  est <- exp_b %*% parms
  # estimate standard error for each interval
  # time variable
  time <- ((rep(1:length(est))-1))
  # covariance matrix for knots 
  cov_mat <- as.matrix(vcov(lag_mod))[names, names]
  # estimate variance of spline
  var <- exp_b %*% cov_mat %*% t(exp_b)
  # estimate lag ----
  # estimate standard error for each lag day for smoke
  l_se <- sqrt(diag(var))
  # calculate lower and upper bound for smoke
  l_est_l95 <- est + (l_se*qnorm(1-0.975))
  l_est_u95 <- est + (l_se*qnorm(0.975))
  l_type <- "lag"
  # lag dataframe
  l_df <- data.frame(strata, l_type, time, 
                     exp(est), exp(l_est_l95), exp(l_est_u95), 
                     row.names = NULL) 
  # assign column names
  colnames(l_df) <- c("strata", "type", "time", 
                      "odds_ratio", "lower_95", "upper_95")
  # cumulative estimates
  c_est <- sapply(seq_along(est), function(x){
    sum(est[1:x])
  })
  # stderr cumulative effect smk
  c_se <- sapply(seq_along(c_est), function(y){
    sqrt(sum(var[1:y,1:y]))
  })
  # estimate 95% CI
  c_l95 <- c_est+(c_se*qnorm(1-0.975))
  c_u95 <- c_est+(c_se*qnorm(0.975))
  # type
  c_type <- "cumulative"
  # return dataframe
  c_df <- data.frame(strata, c_type, time, exp(c_est), 
                     exp(c_l95), exp(c_u95), row.names = NULL) 
  # assign column names
  colnames(c_df) <- c("strata", "type", "time", 
                      "odds_ratio", "lower_95", "upper_95")
  # bind lagged and cumulative 
  lag_est <- rbind(l_df, c_df) %>% 
    mutate(strata = as.character(strata),
           type = as.character(type))
  # return lagged estimate
  return(lag_est)
} # end lag estimate function
```


```{r hosp_dl_results}
# estimating lagged effects
out_rep <- rep(outcome, each = 8)

dl_results  <- lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) 
```

```{r cumulative_cardiopulmonary_results}
# get the cumulative effect over 4 days
cumulative_results <- filter(dl_results, type == 'cumulative' & time == 3) %>% 
    select(-strata, -time) %>% 
    mutate(outcome = forcats::fct_relevel(outcome, out_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
         "Respiratory", "Cardiovascular")))
```

Cumulative effect of 0 to 4 days of smoke exposure for a 10 ug/m^3. 

```{r cumulative_resp_plot}
# plot
plot <- ggplot(data = cumulative_results, 
               aes(x=outcome, y = odds_ratio, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Hospitalization Cumulative Effect of 0 to 4 days Smoke Exposure") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(plot)
```

There may be an association with hospitalizations for asthma and certain cardiovascular events (cerebrovascular, heart failure, IHD) for every 10 ug/m^3 of smoke PM2.5 over the course of 4 days of smoke exposure.

### Respiratory distributed lag effects for a 10 ug/m^3 increase in smoke

Given that some cumulative associations may be significant, I'll plot the daily lagged effect associations. 

```{r resp_dl_plot}
resp_dl <- dl_results %>% 
  mutate(group = as.factor(if_else(out_rep %in% out_order[1:5],
         "Respiratory", "Cardiovascular"))) %>% 
  filter(type == 'lag' & group == 'Respiratory') 

# resp plot
resp_dl_plot <- ggplot(data=resp_dl, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "darkblue", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "darkblue", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_rep, ncol = 2, scales = "free_y") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Lagged Days") +
  ggtitle('Respiratory Lagged Effects') +
  theme_minimal()

resp_dl_plot
```

When you look at the lagged days, some associations like respiratory hospitalizations or asthma have an inverse effect on the same day of exposure. Possible behavior modification or some delay in exposure assessment? This is different from what we observed in Oregon and Washington. Another possible explanation is that they could have been admitted to the ED a day or two before and we don't pick up the signal until a couple days after.

### CVD distributed lag effects for a 10 ug/m^3 increase in smoke

```{r cvd_dl_plot}
cvd_dl <- dl_results %>% 
  mutate(group = as.factor(if_else(out_rep %in% out_order[1:5],
         "Respiratory", "Cardiovascular"))) %>% 
  filter(type == 'lag' & group == 'Cardiovascular') 

# resp plot
cvd_dl_plot <- ggplot(data=cvd_dl, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_rep, ncol = 2, scales = "free_y") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Lagged Days") +
  ggtitle('CVD Lagged Effects') +
  theme_minimal()

cvd_dl_plot
```

## Mortality 

Since we have mortality data, I'm also going to evaluate the association between grid-level smoke PM2.5 and cardiopulmonary mortality. I've created time-stratified case-crossover data frames of cardiopulmonary mortality events with referent period within the same month. I've also limit mortality case-crossover events to Front Range counties from May to October from 2010 to 2015.

```{r mortality}
# load casecrossover list -----
load("../../data/health/co_mortality_cc_list.RData")
# load mortality outcome list
load("../../data/health/icd10_outcome.RData")
```

```{r colorado_mortality_list}
# extract a vector of outcome names from the icd10 outcomes list 
outcomes <- names(icd10_outcomes)

# reduce case-crossover list to only summer months and join pm
co_mortality_list <- casecross_list %>% 
  # desired format to make sure it's right
  map(~ mutate(., outcome = as.numeric(as.character(outcome)),
               date = as.Date(as.character(date_of_death)),
               month = as.factor(lubridate::month(date))) %>% 
      # filter out 2016; I don't have pm data yet
      filter(date <= "2015-12-30") %>% 
      filter(fips %in% fr_fips)) %>% 
  # add outcome name to each dataframe
  map2(.x = ., .y = outcomes, ~mutate(.x, out_name = .y))
```

### Time Series of Respiratory and Cardiovascular Deaths in Colorado 

Number of cardiopulmonary deaths in Front Range counties during this time period.
```{r death_counts}
# estimate deaths 
death_counts <- co_mortality_list %>% 
  map_dfr(. , function(df){
    counts <- df %>% 
      filter(outcome == 1) %>% 
      group_by(out_name) %>% 
      summarise(n_events = n())
    })
# print death counts
knitr::kable(death_counts, caption='Front Range Cardiopulmonary Deaths')
```

Time series of events for respiratory and cvd only. I also aggregated across front range counties for sufficient numbers. Looking for any potential time trends that may need to be accounted for.

```{r ts_death_counts}
# estimate deaths 
ts_death <- co_mortality_list %>% 
  map_dfr(. , function(df){
    counts <- df %>% 
      filter(outcome == 1) %>% 
      group_by(out_name, date) %>% 
      summarise(n = n())
    }) %>% 
  filter(out_name %in% c('resp', 'cvd'))
```

Mortality time-series plot.

```{r ts_death_plots}
ts_death_plot <- ggplot(data=ts_death, aes(x=date, y=n)) +
  geom_point() +
  facet_wrap(~out_name) +
  theme_minimal()

ts_death_plot
```

There is a general increase in cardiovascular deaths over time, which I'm guessing corresponds with the population increase of Colorado. Rates probably would show a more stable rate. Interesting observation in the respiratory related morbidity is the spike at the end of 2014, which I think is because of the bad flu season. I remember Kirk saying this.

I am going to limit mortality to May to October months in 2010 to 2015 and join with PM2.5 estimates.

```{r death_pm}
# extract names
cause_death <- c('Respiratory', 'Asthma', 'COPD', 'CVD', 'Heart Failure',
                 'Cardiac Arrest', 'Ischemic Heart Disease', 
                 'Myocardial Infarction', 'Cerebrovascular')

# reduce case-crossover list to only summer months and join GRID ID
co_death_list <- co_mortality_list %>% 
  # filter out 2016; I don't have pm data yet
  map(~ filter(., date <= "2015-12-30") %>% 
      filter(month %in% 5:10) %>% 
      filter(fips %in% fr_fips) %>% 
      mutate(WRFGRID_ID = as.character(wrfgrid_id)) %>% 
      select(-month, -wrfgrid_id) %>%
      # join with grid key
      left_join(grid_key, by = 'WRFGRID_ID') %>% 
      left_join(co_pm, by = c("fips", "date")) %>% 
      # left join grid pm
      left_join(grid_pm, by = c("GRID_ID", "date"))) %>% 
  # add outcome name to each dataframe
  map2(.x = ., .y = cause_death, ~mutate(.x, out_name = .y))
```

Assessing how many CVD deaths are missing a grid assignment but were assigned a county PM2.5. Not that many missing (~2%).

```{r death_missing_grid}
missing <- co_death_list[[4]] %>% 
  filter(outcome == 1) %>% 
  mutate(county_miss = ifelse(is.na(pm_krig), 1, 0),
         grid_miss = ifelse(is.na(pm25_grid), 1, 0)) %>% 
  group_by(county_miss, grid_miss) %>% 
  summarize(n = n()) %>% 
  mutate(prop = round(n/(17720+402),2))

knitr::kable(missing, caption = 'CVD mortality missing grid PM2.5')
```

### Same Day Association between Smoke and Death

Same analysis as hospitalizations where likelihood of a cardiopulmonary death is regressed a 10 ug/m^3 increase in smoke PM2.5. Model accounts for within subject variability and adjusts for temperature.

```{r sameday_death}
# same day results
same_day_death <- co_death_list %>% 
  map_dfr(., function(df){
    out_name <- unique(df$out_name)
    result <- broom::tidy(clogit(outcome ~ gpm_smk10unit + 
                                 temp_f_grid + strata(id),
                                 data = df)) %>% 
      filter(term == 'gpm_smk10unit') %>% 
      select(term, estimate, conf.low, conf.high) %>% 
      mutate_at(vars(estimate:conf.high), exp) %>% 
      mutate(outcome_name = out_name)
  }) %>% 
  mutate(outcome_name = forcats::fct_relevel(outcome_name, .$outcome_name),
         group = as.factor(ifelse(outcome_name %in% c('Respiratory', 'Asthma', 'COPD'),
                        'Respiratory', 'Cardiovascular')))
```


```{r death_sameday_plot}
death_plot <- ggplot(data=same_day_death, aes(x=outcome_name, y = estimate, 
                                              colour = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Mortality Same Day Association") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75))

print(death_plot)
```

Note there are very few deaths with underlying cause of death as asthma and cardiac arrest and thus a lot of variability. I'm going to plot without these two outcomes so it's easier to read.

```{r death_plot2}
death_plot2 <- ggplot(data = filter(same_day_death, 
                                    !(outcome_name %in% c('Asthma', 'Cardiac Arrest'))),  
                                    aes(x=outcome_name, y = estimate, colour = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Mortality Same Day Association version 2") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75))

print(death_plot2)
```

No significant associations with a 10 ug/m^3 increase in smoke PM2.5 and cardiopulmonary morbidity.

### Cumulative effect for a > 10 ug/m^3 of smoke exposure over 4 days on risk of death

Looking at cumulative exposure of 0 to 4 days of smoke exposure on risk for cardiopulmonary death.

```{r mortality_results}
cod <- rep(cause_death, each = 8)

dl_death_results  <- lapply(co_death_list, function(x){
  # output dataframe from list
  data <- x %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) 
```

Cumulative effect death.

```{r death_cumulative}
cumulative_death_results <- filter(dl_death_results, 
                                   type == 'cumulative' & time == 3) %>% 
    select(-strata, -time) %>% 
    mutate(outcome = forcats::fct_relevel(cod, cause_death),
         group = as.factor(if_else(cod %in% cause_death[1:3],
         "Respiratory", "Cardiovascular"))) %>% 
    filter(!(outcome %in% c('Asthma', 'Cardiac Arrest')))
```

Plot of cumulative effect.
```{r cumulative_death_plot}
# plot
cumulative_death_plot <- ggplot(data = cumulative_death_results , 
               aes(x=outcome, y = odds_ratio, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Mortality Cumulative Smoke Exposure 0 to 4 Days") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(cumulative_death_plot)
```

Removed asthma and cardiac arrest as they were highly variable. I'm also not going to print out lagged effects since there is a lot of variability and the lagged effects are all over the place for some rare events like asthma and there was no association between smoke and cardiopulmonary mortality.

## Binary Smoke Classifier

The continuous definition of smoke may have some misclassification bias, particularly where there is difficulty distinguishing from PM2.5 impacted by smoke and a high anthropocentric PM2.5 day that also happens to have some smoke in the atmospheric column. I am going to try out a binary outcome of > 10 ug/m^3 PM2.5 with HMS overhead as a binary indicator for smoke and look at the association between multiple days of a binary smoke exposure and the risk of cardiopulmonary morbidity.

### Hospitalizations and Binary Smoke

```{r binary_hosp_results}
out_rep <- rep(outcome, each = 8)

hosp_binary_results  <- lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gsmk10_hms_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gsmk10_hms, gsmk10_hms_lag1, 
                             gsmk10_hms_lag2, gsmk10_hms_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) 
```

```{r binary_cumulative_plot}
# get the cumulative effect over 4 days
cumulative_bin_results <- filter(hosp_binary_results, 
                                 type == 'cumulative' & time == 3) %>% 
    select(-strata, -time) %>% 
    mutate(outcome = forcats::fct_relevel(outcome, out_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
         "Respiratory", "Cardiovascular")))

# plot
cbin_hosp_plot <- ggplot(data = cumulative_bin_results, 
               aes(x=outcome, y = odds_ratio, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: Smoke PM"[2.5], " > 10 ug/m"^3))) +
  xlab("Outcome") +
  ggtitle("Hospitalization Cumulative Smoke Exposure 0 to 4 Days") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(cbin_hosp_plot)
```

There is a significant association with this binary cutoff and asthma over 0 to 4 days. Some of the cardiovascular outcomes that were trending towards 'significance' were attenuated to the null here. 

### Mortality

```{r binary_death_results}
cod <- rep(cause_death, each = 8)

binary_death_results  <- lapply(co_death_list, function(x){
  # output dataframe from list
  data <- x %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gsmk10_hms, gsmk10_hms_lag1, 
                             gsmk10_hms_lag2, gsmk10_hms_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) 
```

```{r binary_cumulative_death}
# get the cumulative effect over 4 days
c_bin_death_results <- filter(binary_death_results, 
                                   type == 'cumulative' & time == 3) %>% 
    select(-strata, -time) %>% 
    mutate(outcome = forcats::fct_relevel(cod, cause_death),
         group = as.factor(if_else(cod %in% cause_death[1:3],
         "Respiratory", "Cardiovascular"))) %>% 
    filter(!(outcome %in% c('Asthma', 'Cardiac Arrest')))

# plot
cbin_death_plot <- ggplot(data = c_bin_death_results, 
               aes(x=outcome, y = odds_ratio, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  scale_color_manual("Cardiopulmonary", values = c("#ff00cc", "darkblue")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  ylab(expression(paste("Odds Ratio: Smoke PM"[2.5], " > 10 ug/m"^3))) +
  xlab("Outcome") +
  ggtitle("Mortality Cumulative Smoke Exposure 0 to 4 Days") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(cbin_death_plot)
```

No association with mortality.

## Fire/Smoke Event-Specific

Looking at specific fires. I think isolating to specific counties impacted by specific fires gives me more confidence in the kriged models to understand the exposure series. We've also used this approach in Washington and Oregon studies. I'm going to run separate models in each section, but plot estimates side by side in a couple plots.

Since there are fewer deaths for some of the subcategories and I'm reducing further to specific times and counties, I'm going to only look at respiratory and cardiovascular general categories of underlying cause of death.

### Four-Mile Canyon Fire 2010

The first fire I'll look at is the Four-Mile Canyon Fire that occurred west of Boulder. It started on September 7, 2010 and contained on September 13th. I will limit the time frame to 2010-05-01 to 2010-10-31 and to Boulder County only. I'm open to adding additional counties known to be impacted by wildfire smoke.

```{r fourmile_hosp_results}
out_rep <- rep(outcome, each = 8)

mile4_hosp_cont <-lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    # filter to boulder
    filter(fips == '08013') %>% 
    filter(date >= '2010-05-01' & date <= '2010-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) %>% 
  mutate(event = 'Four Mile 2010')
```

```{r mile4_deaths}
cod <- rep(names(co_death_list[c(1,4)]), each=8)

mile4_death_cont <- lapply(co_death_list[c(1,4)], function(x){
  # output dataframe from list
  data <- x %>%     
    # filter to boulder
    filter(fips == '08013') %>% 
    filter(date >= '2010-05-01' & date <= '2010-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) %>% 
  mutate(event = 'Four Mile 2010')
```

### Waldo Canyon 2012

Waldo Canyon started on June 23rd 2012 and burned until July 10th 2012 near Colorado Springs. Limiting to events from El Paso County to assess impact of smoke. Are there other counties I should consider? 

Limiting hospitalizations and deaths to May 2012 through August 2012. I'm consider expanding time frame and other counties too. 
```{r waldo_hosp_results}
out_rep <- rep(outcome, each = 8)

waldo_hosp_cont <-lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    # filter to el paso
    filter(fips == '08041') %>% 
    filter(date >= '2012-05-01' & date <= '2012-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) %>% 
  mutate(event = 'Waldo Canyon 2012')
```


```{r waldo_death_results}
cod <- rep(names(co_death_list[c(1,4)]), each=8)

waldo_death_cont <- lapply(co_death_list[c(1,4)], function(x){
  # output dataframe from list
  data <- x %>%     
    # filter to el paso
    filter(fips == '08041') %>% 
    filter(date >= '2012-05-01' & date <= '2012-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) %>% 
  mutate(event = 'Waldo Canyon 2012')
```

### High Park Fire

For this fire, I'm limiting hospitalizations and deaths to May 2012 through August 2012 occurring in Larmier county.

```{r highpark_hosp_results}
out_rep <- rep(outcome, each = 8)

hipark_hosp_cont <-lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    # filter to larimer
    filter(fips == '08069') %>% 
    filter(date >= '2012-05-01' & date <= '2012-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) %>% 
  mutate(event = 'High Park 2012')
```

```{r hipark_deaths}
cod <- rep(names(co_death_list[c(1,4)]), each=8)

hipark_death_cont <- lapply(co_death_list[c(1,4)], function(x){
  # output dataframe from list
  data <- x %>%     
    # filter to el paso
    filter(fips == '08069') %>% 
    filter(date >= '2012-05-01' & date <= '2012-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) %>% 
  mutate(event = 'High Park 2012')
```


### 2015 Transported Smoke

Fires in Canada and Washington led to the transported smoke event that affected the Front Range communities in Colorado in 2015. I have limited this analysis to 2015-05-01 to 2015-10-31 (note hospitalizations only go until 2015-10-01). I included all Front Range counties.

```{r transport_hosp_results}
out_rep <- rep(outcome, each = 8)

trans_hosp_cont <-lapply(co_hosp_list, function(x){
  # output dataframe from list
  data <- x %>% 
    filter(date >= '2015-05-01' & date <= '2015-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(out_rep), .) %>% 
  mutate(event = 'Transport 2015')
```

```{r transport_deaths}
cod <- rep(names(co_death_list[c(1,4)]), each=8)

trans_death_cont <- lapply(co_death_list[c(1,4)], function(x){
  # output dataframe from list
  data <- x %>%     
    filter(date >= '2015-05-01' & date <= '2015-10-31') %>% 
    mutate(date = as.Date(date),
           outcome = as.numeric(as.character(outcome))) %>%
    # remove missing lagged data
    filter(!is.na(gpm_smk10unit_lag3))

  # create lagged matrix
  pm_mat <- as.matrix(select(data, gpm_smk10unit, gpm_smk10unit_lag1, 
                             gpm_smk10unit_lag2, gpm_smk10unit_lag3))
  
  # temp matrix
  temp_mat <- as.matrix(select(data, temp_f_grid, temp_f_grid_lag1,
                               temp_f_grid_lag2, temp_f_grid_lag3))
  # define lagged basis spline
  exp_b <- splines::ns(0:(ncol(pm_mat)-1), df = 3, intercept = T)
  # pm basis
  pm_basis <- pm_mat %*% exp_b
  # temp basis
  temp_basis <- temp_mat %*% exp_b
  temp_basis <-
  # run lagged model
  lag_mod <- clogit(outcome ~ pm_basis + temp_basis + strata(id), data = data)

  # estimate lag estimate
  lag_est <- distribute_that_lag(lag_mod, strata = "pm") 
  return(lag_est)
  }) %>%  #end lappply
  # bind rows
  map_dfr(.,rbind) %>% 
  # bind in outcome names
  bind_cols(data.frame(cod), .) %>% 
  mutate(event = 'Transport 2015')
```

### Different Event and Hospitalization Plots

Plots of association for each hospitalization outcome by event. I left out Four Mile Canyon fire since there were so few events the estimates were unstable. This can probably be fixed by adding in other counties that were impacted by smoke.

```{r hosp_event_plot}
# bind event dataframes together
hosp_event <- bind_rows(mile4_hosp_cont, waldo_hosp_cont, hipark_hosp_cont,
                        trans_hosp_cont) %>% 
  filter(type == 'cumulative' & time == 3) %>% 
  select(-strata, -time) %>% 
  mutate(outcome = forcats::fct_relevel(out_rep, out_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
         "Respiratory", "Cardiovascular"))) %>% 
  # filter out any estimates from four mile canyon with high variability
  filter(event != 'Four Mile 2010') %>% 
  # filter out acute bronchitis
  filter(outcome != 'Acute Bronchitis')

# plot
hosp_event_plot <- ggplot(data = hosp_event, 
                          aes(x=outcome, y=odds_ratio, color = event)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  facet_wrap(~event, scales = 'free_y') +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Hospitalization Cumulative Smoke Exposure 0 to 4 Days") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(hosp_event_plot)
```

I think this plot is kind of interesting for asthma, where the only significant association is with the 2015 transport smoke. I think Sheryl and I hypothesized that there might be an effect here because the first couple days of the smoke event were really hard to tell there was actual smoke and not fog. Also note that I included all front range counties because there were air quality warning up and down the front range. I think we could also do a 2012 to 2015 comparison. This might actually be the cleanest way to do this analysis, with the argument that the Front Range was impacted by smoke from two large fires in 2012 and impacted by smoke from transported smoke.

I left out Four Mile Canyon fire for now since the estimates were unstable due to few events.

```{r mortality_event_plot}
# bind event dataframes together
death_event <- bind_rows(mile4_death_cont, waldo_death_cont, hipark_death_cont,
                        trans_death_cont) %>% 
  filter(type == 'cumulative' & time == 3) %>% 
  select(-strata, -time) %>% 
  mutate(outcome = ifelse(cod == 'resp', 'Respiratory', 'Cardiovascular')) %>% 
  # filter out any estimates from four mile canyon with high variability
  filter(event != 'Four Mile 2010') 

# plot
death_event_plot <- ggplot(data = death_event, 
                          aes(x=outcome, y=odds_ratio, color = event)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower_95, ymax=upper_95), width = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  facet_wrap(~event, scales = 'free_y') +
  ylab(expression(paste("Odds Ratio: 10 ug/m"^3, " Increase in Smoke PM"[2.5]))) +
  xlab("Outcome") +
  ggtitle("Mortality Cumulative Smoke Exposure 0 to 4 Days") +
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust=0.95, vjust = 0.75,
                                   size = 10))

print(death_event_plot)
```

No association with deaths. 

## Conclusions

I think there could be something interesting looking at 2012 vs. 2015 smoke, where transported smoke could be a risk factor. The hypothesis here could be that people are aware of smoke from local fires since they are publicized, where the transported smoke was not clear to people until there were air quality warnings. Mortality doesn't seem to be associated with these short-term smoke events.