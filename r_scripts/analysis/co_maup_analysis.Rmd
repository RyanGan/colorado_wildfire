---
title: "Environmental Epidemiology and the Modifiable Areal Unit Problem"
author: "Ryan Gan"
date: '2018-03-22'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

# Introduction

Environmental epidemiology rarely has individual-level estimates of exposure for study participants/outcomes observations. Exposure is assigned based on reported place of residence, which can vary on resolution based on data use agreements. 

For this particular set of analyses, I want to estimate the cardiopulmonary morbidity/mortality of PM~2.5~ assigned at the county-level, zipcode-level, and a 15 km^2^ grid level. 

I will use Colorado mortality and hospital discharge data I received from Kirk Bol at CDPHE. I have residential location of county, zipcode, and a 3x3 grid size. This document only focuses on the association of PM~2.5~ assigned at the county-level to comply with the spatial resolution Rish has.

```{r library}
# libraries
library(tidyverse) # data wrangle/plot
library(survival) # conditional logistic models
library(splines) # splines
library(lubridate) # works with dates
library(broom)
library(stringr)

# knitr options
knitr::opts_chunk$set(fig.width=8, fig.height=6, quite = T, message = F)
```

## PM~2.5~ Exposure

Setting up funlag function to create lagged datastructures. 

```{r funlag}
# defining a lag function
funlag <- function(var, n=6){
  var <- enquo(var)
  indices <- seq_len(n)
  map( indices, ~quo(lag(!!var, !!.x)) ) %>% 
    set_names(sprintf("%s_lag%d", rlang::quo_text(var), indices))
}
```

### Grid Exposure

Import grid exposure values.

```{r grid_exp_impor}
# read grid pm
grid_pm <- read_csv("../../data/smoke/1015-grid_pm.csv", col_types = "cDdddd") %>% 
  mutate(pm_diff_grid = pm25_grid - sbg_pm_grid,
         month = as.factor(lubridate::month(date)), # extract month as factor
         year = as.factor(lubridate::year(date)), # extract year as factor
         season = as.factor(case_when(month %in% c(12, 1, 2) ~ "winter",
                                      month %in% c(3:5) ~ "spring",
                                      month %in% c(6:8) ~ "summer",
                                      month %in% c(9:11)~ "fall")),
         # creating binary smoke to hms to be equal to 1 
         # and difference between estimate and seasonal background to be >0
         # and to be within the month of April to Octoboer
         smk0_hms_g = ifelse(pm_diff_grid > 0 & month %in% c(4:10) & 
                               hms == 1, 1, 0),
         smk5_hms_g = ifelse(pm_diff > 5 & month %in% c(4:10) & hms > 0.1, 1, 0),
         smk10_hms_g = ifelse(pm_diff > 10 & month %in% c(4:10) & hms > 0.1, 1, 0),
         smk15_hms_g = ifelse(pm_diff > 15 & month %in% c(4:10) & hms > 0.1, 1, 0),
         # transforming pm kriged estimates to a 10 unit increase in pm
         pm = pm_krig/10) %>% 
  # sorting by fips and date to estimate lag for each county by date
  arrange(fips, date) %>% 
  # group by fips 
  group_by(fips) %>%
  # apply funlag to create lagged estimates
  mutate(., !!!funlag(pm,6), !!!funlag(smoke0_hms,6), !!!funlag(smoke5_hms,6),
         !!!funlag(smoke10_hms,6), !!!funlag(smoke15_hms,6), 
         !!!funlag(temp_f, 6))
# head of first pm values
head(grid_pm)
```

```{r import_county_pm}
county_pm <- read_csv(paste0("../../../meta_wildfire/data/smoke/",
  "1015-county_popwt_pm.csv")) %>% 
  # limiting to colorado counties only by reading 1st 2 digs of 5-dig fips code
  filter(str_sub(fips,start=1,end=2) %in% c("08")) %>% 
  rename(pm25_c = pm_krig, sbg_pm_c = bg_pm, pm_diff_c = pm_smk, hms_c = hms,
         temp_f_c = temp_f, aqi_c = aqi, aqi_cat_c = aqi_cat)

head(county_pm)
```


Import case-cross list
```{r}

```

